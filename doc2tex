#!/usr/local/bin/perl

sub printTeX
{ s/`([@\w]+)\s*<->(\w+)/\\index{\l\1,\\both{\2}}`\1 \\both{\2}/g;
  s/`([@\w]+)\s*<-(\w+)/\\index{\l\1,\\get{\2}}`\1 \\get{\2}/g;
  s/`([@\w]+)\s*->(\w+)/\\index{\l\1,\\send{\2}}`\1 \\send{\2}/g;
  s/<->(\w+)/\\both{\1}/g;
  s/<-(\w+)/\\get{\1}/g;
  s/->(\w+)/\\send{\1}/g;
  s/([a-z]\w+)\/((\d+|\[\d+(-|,)\d+\]))/\\index{\l\1\/\2}\\predref{\l\1}{\2}/g;
  s/(\w\.\w)\.(\s+[a-z])/\1.\\\2/g;
  s/(^|[^\w}])@(\w+)/\1\\index{@\2}\\objectname{\2}/g;
  s/<([A-Z]+)>/\\HTML{\1}/g;
  s/<(\w[-~\w]*)>/\\bnfmeta{\1}/g;
  s/\\class{([<\\=>]*)}/\\verb!\1!/g;
  s/==>/\$\\longrightarrow\$/g;
  s/^(\s *\\sendmethod\{.*\}) *$/\1%/;
  s/^(\s *\\getmethod\{.*\}) *$/\1%/;
  s/^(\s *\\bothmethod\{.*\}) *$/\1%/;
  s/^(\s *\\predicate\{.*\}) *$/\1%/;
  s/^(\s *\\noargpredicate\{.*\}) *$/\1%/;
  s/^(\s *\\directive\{.*\}) *$/\1%/;
  s/^(\s *\\expanded\{.*\}) *$/\1%/;
  s/^((\\index{[^}]+})+) *$/\1%/;

  print;
}


sub expandTabs
{ while ( ($i = index($_, "\t")) != $[-1 )
  { $nspaces = 8 - $i % 8;
    for( $spaces="", $i=0; $i<$nspaces; $i++ )
    { $spaces .= " ";
    }
    s/\t/$spaces/;
  }
}


sub
expandSpecials
{ s/\^/\\verb!^!/g;
  s/\|/\\verb!|!/g;
}


sub printCode
{ print;
  while (<ARGV> )
  { &expandTabs;
    print;
    if ( /\\end{(code|verbatim)}/ )
    { return;
    }
  }
}


sub printPceCode
{ $line = 0;
  print;
  while (<ARGV> )
  { $line++;
    &expandTabs;
    if ( /\\end{pcecode}/ )
    { print;
      return;
    }
    chomp;
    print "\\lineno{$line}\\verb`$_`\n";
  }
}


sub skiptonext
{ while (<ARGV>)
  { if ( ! /^\s*$/ )
    { return;
    }
    last;
  }
  while (<ARGV>)
  { if ( ! /^\s*$/ )
    { return;
    }
  }
}

#	MAIN PROGRAM

while (<>)
{ while ( /\\begin{pcecode}/ )
  { &printPceCode;
    print "\n\\noindent\n";
    &skiptonext;
  } 
  while ( /\\begin{(code|verbatim)}/ )
  { &printCode;
    print "\n\\noindent\n";
    &skiptonext;
  }
  &printTeX;
}
